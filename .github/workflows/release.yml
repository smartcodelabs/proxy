name: Release

on:
  push:
    # Only create releases from tags - branch pushes handled by build.yml
    tags:
      - 'v*'
      - '[0-9][0-9][0-9][0-9].[0-9][0-9].[0-9][0-9]-*'  # Hytale version format: 2026.01.17-*
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'dev'
        type: choice
        options:
          - stable
          - dev

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.2.0'

      - name: Build with Gradle
        run: gradle build --no-daemon --stacktrace

      - name: Verify build artifacts exist
        run: |
          echo "Checking for build artifacts..."
          ls -la proxy/build/libs/ || { echo "ERROR: proxy artifacts missing"; exit 1; }
          ls -la api/build/libs/ || { echo "ERROR: api artifacts missing"; exit 1; }
          ls -la bridge/build/libs/ || { echo "ERROR: bridge artifacts missing"; exit 1; }
          ls -la bridge-packets/build/libs/ || { echo "ERROR: bridge-packets artifacts missing"; exit 1; }

      - name: Get Hytale server versions from gradle.properties
        id: hytale_version
        run: |
          # Get all compatible versions (comma-separated)
          ALL_VERSIONS=$(grep "^hytaleServerVersions=" gradle.properties | cut -d'=' -f2 || echo "unknown")
          echo "all_versions=$ALL_VERSIONS" >> $GITHUB_OUTPUT
          
          # Get primary version (first in list) for tagging
          PRIMARY_VERSION=$(echo "$ALL_VERSIONS" | cut -d',' -f1 | xargs)
          echo "primary_version=$PRIMARY_VERSION" >> $GITHUB_OUTPUT
          
          # Count versions
          VERSION_COUNT=$(echo "$ALL_VERSIONS" | tr ',' '\n' | wc -l)
          echo "version_count=$VERSION_COUNT" >> $GITHUB_OUTPUT
          
          # Format for display (replace commas with newlines for markdown)
          VERSIONS_LIST=$(echo "$ALL_VERSIONS" | tr ',' '\n' | sed 's/^/- `/' | sed 's/$/`/')
          echo "versions_list<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSIONS_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Hytale Server Versions: $ALL_VERSIONS"
          echo "Primary Version: $PRIMARY_VERSION"

      - name: Get project version from gradle.properties
        id: version
        run: |
          VERSION=$(grep "^version=" gradle.properties | cut -d'=' -f2 || echo "1.0-SNAPSHOT")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Project version: $VERSION"

      - name: Determine release type
        id: release_type
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger - use input
            TYPE="${{ github.event.inputs.release_type }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # v* tags are stable releases
            TYPE="stable"
          else
            # Hytale version tags default to stable
            TYPE="stable"
          fi
          
          if [[ "$TYPE" == "stable" ]]; then
            echo "type=stable" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "suffix=" >> $GITHUB_OUTPUT
          else
            echo "type=dev" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "suffix=-dev" >> $GITHUB_OUTPUT
          fi
          echo "Release type: $TYPE"

      - name: Create release tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Use the pushed tag directly
            TAG="${{ github.ref_name }}"
          else
            # Generate tag for manual dispatch
            PRIMARY_VER="${{ steps.hytale_version.outputs.primary_version }}"
            SUFFIX="${{ steps.release_type.outputs.suffix }}"
            BUILD_NUM="${{ github.run_number }}"
            
            if [[ "$PRIMARY_VER" != "unknown" && -n "$PRIMARY_VER" ]]; then
              TAG="${PRIMARY_VER}${SUFFIX}-build.${BUILD_NUM}"
            else
              TAG="v${{ steps.version.outputs.version }}${SUFFIX}-build.${BUILD_NUM}"
            fi
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Prepare release artifacts
        run: |
          mkdir -p release
          
          # Copy artifacts and fail if none found
          cp proxy/build/libs/proxy-*.jar release/
          
          # Copy API jar excluding javadoc and sources
          for jar in api/build/libs/api-*.jar; do
            case "$jar" in
              *-javadoc.jar|*-sources.jar) continue ;;
              *) cp "$jar" release/ ;;
            esac
          done
          
          # Copy bridge jars excluding javadoc and sources
          for jar in bridge/build/libs/bridge-*.jar; do
            case "$jar" in
              *-javadoc.jar|*-sources.jar) continue ;;
              *) cp "$jar" release/ ;;
            esac
          done
          
          # Copy bridge-packets jars excluding javadoc and sources
          for jar in bridge-packets/build/libs/bridge-packets-*.jar; do
            case "$jar" in
              *-javadoc.jar|*-sources.jar) continue ;;
              *) cp "$jar" release/ ;;
            esac
          done
          
          echo "Release artifacts:"
          ls -la release/
          
          # Verify we have artifacts
          ARTIFACT_COUNT=$(ls release/*.jar 2>/dev/null | wc -l)
          if [[ "$ARTIFACT_COUNT" -eq 0 ]]; then
            echo "ERROR: No artifacts found for release!"
            exit 1
          fi
          echo "Found $ARTIFACT_COUNT artifact(s)"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Numdrassl ${{ steps.tag.outputs.tag }}"
          body: |
            ## Numdrassl Proxy Release

            **Release Type:** ${{ steps.release_type.outputs.type == 'stable' && 'ðŸŸ¢ Stable' || 'ðŸŸ¡ Development' }}
            **Proxy Version:** `${{ steps.version.outputs.version }}`
            **Build:** `#${{ github.run_number }}`
            **Commit:** [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

            ---

            ### ðŸŽ® Compatible Hytale Server Versions

            ${{ steps.hytale_version.outputs.versions_list }}

            > **Primary Version:** `${{ steps.hytale_version.outputs.primary_version }}`

            ---

            ### ðŸ“¦ Artifacts

            | File | Description |
            |------|-------------|
            | `proxy-*.jar` | Main proxy server |
            | `api-*.jar` | Plugin API (for plugin developers) |
            | `bridge-*.jar` | Backend server plugin (install on Hytale servers) |
            | `bridge-packets-*.jar` | Backend server earlyplugin (install on Hytale servers) |

            ---

            ### ðŸš€ Quick Start

            1. Download `proxy-*.jar`
            2. Run: `java -jar proxy-*.jar`
            3. Use `auth login` to authenticate with Hytale
            4. See [README](https://github.com/${{ github.repository }}/blob/main/README.md) for full setup

            ### ðŸ”Œ Backend Setup

            1. Download `bridge-*.jar`
            2. Place in your Hytale server's `mods/` folder
            3. Download `bridge-packets-*.jar`
            4. Put the file into your Hytale serverâ€™s `earlyplugins/` folder (create it if it doesnâ€™t exist).
            5. Start server with `--auth-mode insecure --transport QUIC --accept-early-plugins`
            6. Configure matching `SecretKey` in both proxy and bridge configs 

          draft: false
          prerelease: ${{ steps.release_type.outputs.prerelease }}
          files: |
            release/*.jar
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`${{ steps.tag.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Type** | ${{ steps.release_type.outputs.type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Compatible Versions** | ${{ steps.hytale_version.outputs.version_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Primary Version** | \`${{ steps.hytale_version.outputs.primary_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Proxy Version** | \`${{ steps.version.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Compatible Hytale Versions" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.hytale_version.outputs.versions_list }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la release/*.jar >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}
      release_type: ${{ steps.release_type.outputs.type }}

  # Publish to Maven Central (only for stable releases)
  publish-maven:
    name: Publish to Maven Central
    needs: release
    if: needs.release.outputs.release_type == 'stable'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Extract version from tag
        id: extract_version
        run: |
          TAG="${{ needs.release.outputs.tag }}"
          # Extract semantic version from tag (remove v prefix if present)
          VERSION="${TAG#v}"
          # For Hytale format tags, use the project version
          if [[ "$VERSION" =~ ^[0-9]{4}\.[0-9]{2}\.[0-9]{2} ]]; then
            VERSION="${{ needs.release.outputs.version }}"
            # Remove -SNAPSHOT if present for releases
            VERSION="${VERSION%-SNAPSHOT}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Publish to Maven Central
        run: |
          ./gradlew :api:publishMavenPublicationToOSSRHRepository \
            -Pversion=${{ steps.extract_version.outputs.version }} \
            --no-daemon
        env:
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        continue-on-error: true  # Don't fail release if Maven Central publish fails

      - name: Maven Central Summary
        run: |
          echo "## ðŸ“¦ Maven Central Publishing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.extract_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependency" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`xml" >> $GITHUB_STEP_SUMMARY
          echo "<dependency>" >> $GITHUB_STEP_SUMMARY
          echo "    <groupId>me.internalizable.numdrassl</groupId>" >> $GITHUB_STEP_SUMMARY
          echo "    <artifactId>numdrassl-api</artifactId>" >> $GITHUB_STEP_SUMMARY
          echo "    <version>${{ steps.extract_version.outputs.version }}</version>" >> $GITHUB_STEP_SUMMARY
          echo "</dependency>" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> Note: It may take up to 2 hours for the artifact to appear on Maven Central." >> $GITHUB_STEP_SUMMARY

